box: node
build:
 steps:
     - npm-install
deploy:
    steps:
      - internal/docker-push:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        repository: slawekpelka/carl-discord-bot
        ports: 22
        cmd: /bin/bash -c “cd /pipeline/source && supervisor - watch ./src src/server.js”
      - add-ssh-key:
          keyname: DIGITAL_OCEAN
      - add-to-known_hosts:
          hostname: 188.226.147.210
      - script:
          name: stop pm2 carl2 image
          script: ssh root@188.226.147.210 pm2 stop carl2
      - script:
          name: pull latest image
          code: ssh root@188.226.147.210 docker pull slawekpelka/carl-discord-bot:latest
      - script:
          name: stop running container
          code: ssh root@188.226.147.210 docker stop carl-discord-bot || echo ‘failed to stop running container’
      - script:
          name: remove stopped container
          code: ssh root@188.226.147.210 docker rm carl-discord-bot || echo ‘failed to remove stopped container’
      - script:
          name: remove image behind stopped container
          code: ssh root@188.226.147.210 docker rmi slawekpelka/carl-discord-bot:current || echo ‘failed to remove image behind stopped container’
      - script:
          name: tag newly pulled image
          code: ssh root@188.226.147.210 docker tag slawekpelka/carl-discord-bot:latest slawekpelka/carl-discord-bot:current
      - script:
          name: run new container
          code: ssh root@188.226.147.210 docker run -d -p 8080:22 --name carl-discord-bot slawekpelka/carl-discord-bot:current
      - script:
          name: start pm2 carl2
          code: ssh root@188.226.147.210 npm run prod